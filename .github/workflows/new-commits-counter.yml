name: Count All Contributions

on:
  workflow_dispatch:

jobs:
  count_contributions:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install axios

      - name: Count contributions by year
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_USER: "tu-usuario" # ReemplazÃ¡ con tu user de GitHub
        run: |
          node << 'EOF'
          const axios = require('axios');

          const token = process.env.GITHUB_TOKEN;
          const username = process.env.GITHUB_USER;
          const currentYear = new Date().getFullYear();

          let total = 0;

          const query = (from, to) => ({
            query: `
              query {
                user(login: "${username}") {
                  contributionsCollection(from: "${from}", to: "${to}") {
                    contributionCalendar {
                      totalContributions
                    }
                  }
                }
              }
            `
          });

          const headers = {
            Authorization: `bearer ${token}`
          };

          (async () => {
            for (let year = 2008; year <= currentYear; year++) {
              const from = `${year}-01-01T00:00:00Z`;
              const to = `${year}-12-31T23:59:59Z`;

              try {
                const res = await axios.post('https://api.github.com/graphql', query(from, to), { headers });
                const count = res.data.data.user.contributionsCollection.contributionCalendar.totalContributions;
          
                if (count > 0) {
                  console.log(`AÃ±o ${year}: ${count} contribuciones`);
                  total += count;
                }
              } catch (error) {
                console.error(`Error consultando ${year}:`, error.response?.data || error.message);
              }
            }

            console.log(`ðŸŽ‰ Total de contribuciones desde el primer aÃ±o con actividad: ${total}`);
          })();
          EOF
